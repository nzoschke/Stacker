#!/bin/bash
set -xo pipefail

display() { echo -e "\n----->" $*; }
abort()   { echo $* ; exit 1; }
indent()  { sed -u "s/^/       /"; }

[ $# -eq 1 ] && [ -f $1 ] || abort usage: $(basename $0) SCRIPT

SCRIPT=$1
BASE_TARGET=lucid
BASE_TARGET_DIR=$BASE_TARGET-root
TARGET=$(basename ${SCRIPT%.*}) # /vagrant/stacks/cedar-2.0.0.sh => cedar-2.0.0
TARGET_DIR=$TARGET-root
MOUNT_DIR=/mnt/$TARGET

# find or create a base lucid debootstrap
if [ ! -d $BASE_TARGET_DIR ]; then
  display Creating template lucid debootstrap
  (
    apt-get update > /dev/null
    apt-get install -y debootstrap
    debootstrap --variant=minbase lucid $BASE_TARGET_DIR
  ) 2>&1 | indent
fi

# rsync into work dir
display Copying template lucid to target dir
rsync -a --delete $BASE_TARGET_DIR/ $TARGET_DIR/

# chroot and build
display Mounting host in target dir
mount --bind /dev  $TARGET_DIR/dev
mount --bind /proc $TARGET_DIR/proc
function on_exit() {
  umount $TARGET_DIR/dev $TARGET_DIR/proc 2>&1 | indent
}
trap on_exit EXIT

display Building inside target
(
  cp $SCRIPT $TARGET_DIR/tmp/build.sh
  chroot $TARGET_DIR /tmp/build.sh
) 2>&1 | indent

